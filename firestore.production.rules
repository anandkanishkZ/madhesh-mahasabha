rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // PRODUCTION RULES - Secure rules for live deployment
    // Use these rules when you're ready to go live
    
    match /contact-messages/{document} {
      // Allow anyone to create new contact messages with validation
      allow create: if isValidContactMessage(resource.data);
      
      // Only authenticated admin users can read messages
      allow read: if request.auth != null && 
                     request.auth.token.admin == true;
      
      // Prevent updates and deletes for security
      allow update, delete: if false;
    }
    
    match /membership-applications/{document} {
      // Allow anyone to create new membership applications with validation
      allow create: if isValidMembershipApplication(resource.data);
      
      // Only authenticated admin users can read applications
      allow read: if request.auth != null && 
                     request.auth.token.admin == true;
      
      // Prevent updates and deletes for security
      allow update, delete: if false;
    }
    
    // Helper function to validate contact message data
    function isValidContactMessage(data) {
      return data.keys().hasAll(['name', 'email', 'subject', 'message', 'timestamp']) &&
             data.name is string && data.name.size() > 0 && data.name.size() <= 100 &&
             data.email is string && data.email.matches('.*@.*\\..*') && data.email.size() <= 254 &&
             data.subject is string && data.subject.size() > 0 && data.subject.size() <= 200 &&
             data.message is string && data.message.size() > 0 && data.message.size() <= 2000 &&
             data.timestamp is timestamp &&
             // Optional fields validation
             (!data.keys().hasAny(['phone']) || (data.phone is string && data.phone.size() <= 20)) &&
             (!data.keys().hasAny(['organization']) || (data.organization is string && data.organization.size() <= 100));
    }
    
    // Helper function to validate membership application data
    function isValidMembershipApplication(data) {
      return data.keys().hasAll(['fullName', 'email', 'phone', 'address', 'timestamp']) &&
             data.fullName is string && data.fullName.size() > 0 && data.fullName.size() <= 100 &&
             data.email is string && data.email.matches('.*@.*\\..*') && data.email.size() <= 254 &&
             data.phone is string && data.phone.size() > 0 && data.phone.size() <= 20 &&
             data.address is string && data.address.size() > 0 && data.address.size() <= 300 &&
             data.timestamp is timestamp &&
             // Optional fields validation
             (!data.keys().hasAny(['occupation']) || (data.occupation is string && data.occupation.size() <= 100)) &&
             (!data.keys().hasAny(['education']) || (data.education is string && data.education.size() <= 100)) &&
             (!data.keys().hasAny(['experience']) || (data.experience is string && data.experience.size() <= 500)) &&
             (!data.keys().hasAny(['motivation']) || (data.motivation is string && data.motivation.size() <= 1000));
    }
    
    // Deny all other operations by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}